<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gary's Capybara Flashcard App</title>

  <!-- Fonts: Montserrat (body) + Lobster (heading) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Lobster&display=swap">

  <style>
    /* 
      1) Unified color palette: warm orange/brown (#E6A15E) 
      2) Lightened background with overlay 
      3) Larger border-radius & softer shadows 
      4) Consistent button styling 
      5) Subtle hover transitions 
      6) Fancy heading (Lobster) 
    */

    /* ============ Body & Background ============ */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      /* Use Montserrat for main text */
      font-family: 'Montserrat', sans-serif;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;

      /* Capybara image with a semi-transparent white overlay for clarity */
      background: 
        linear-gradient(rgba(255,255,255,0.3), rgba(255,255,255,0.3)), 
        url('capybara-theme.png') no-repeat center center fixed;
      background-size: cover;
    }

    /* ============ Heading ============ */
    h1 {
      margin-top: 2vw;
      margin-bottom: 1vw;
      font-family: 'Lobster', cursive; /* fancy cursive font */
      color: #8B4513; /* warm brown text */
      text-shadow: 1px 1px 2px rgba(255,255,255,0.8);
      background: rgba(255,255,255,0.6);
      padding: 1vw 2vw;
      border-radius: 1vw;
      font-size: 2.5vw;
    }

    /* ============ Containers ============ */
    .controls,
    #csv-import,
    #question-form,
    #set-management {
      width: 90%;
      max-width: 900px;
      background: rgba(255,255,255,0.7);
      border-radius: 2vw; /* bigger rounding */
      padding: 2vw;
      margin: 1vw 0;
      /* softer shadow */
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      position: relative;
    }

    #flashcards-container {
      width: 90%;
      max-width: 900px;
      margin: 1vw 0;
    }

    /* ============ Flashcards ============ */
    .flashcard {
      background: rgba(255,255,255,0.8);
      border-radius: 2vw;
      padding: 2vw;
      margin-bottom: 2vw;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: transform 0.2s;
      position: relative;
    }
    .flashcard:hover {
      transform: scale(1.02);
    }
    .question {
      font-size: 1.2vw;
      margin-bottom: 1vw;
      font-weight: bold;
      color: #2c2c2c;
    }
    .options {
      list-style: none;
      padding: 0;
    }
    .options li {
      padding: 1vw 1.5vw;
      margin: 1vw 0;
      background: #f1f1f1;
      border-radius: 0.5vw;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      font-size: 1vw;
    }
    .options li:hover {
      background: #e0e0e0;
    }
    .options li.selected {
      background: #5563DE;
      color: #fff;
    }
    .feedback {
      font-size: 1vw;
      font-weight: bold;
      text-align: center;
      margin-top: 1vw;
      padding: 1vw;
      border-radius: 0.8vw;
      display: none;
    }
    .feedback.correct {
      background: #4CAF50;
      color: #fff;
    }
    .feedback.incorrect {
      background: #F44336;
      color: #fff;
    }
    .remove-btn {
      position: absolute;
      bottom: 1vw;
      right: 1vw;
      background: #f44336;
      font-size: 1vw;
      padding: 0.5vw 1vw;
      border: none;
      border-radius: 0.5vw;
      cursor: pointer;
      transition: background 0.3s;
    }
    .remove-btn:hover {
      background: #c0392b;
    }

    /* ============ Buttons ============ */
    button {
      font-family: 'Montserrat', sans-serif;
      font-weight: 500;
      margin: 0.5vw;
      padding: 1vw 1.5vw;
      font-size: 1vw;
      background: #E6A15E; /* unify color */
      color: #fff;
      border: none;
      border-radius: 1vw;
      cursor: pointer;
      /* subtle hover transitions */
      transition: background 0.3s, transform 0.2s;
    }
    button:hover {
      background: #d89054;
      transform: translateY(-2px);
    }

    /* ============ Submit & Reset (floating) ============ */
    #submit-btn {
      position: fixed;
      left: 2vw;
      top: 50vh;
      transform: translateY(-50%);
      z-index: 999;
      font-size: 2vw;
      padding: 1.2vw 2vw;
      box-shadow: 0.4vw 0.4vw 0.8vw rgba(0,0,0,0.3);
    }
    #reset-floating-btn {
      display: none;
      position: fixed;
      left: 2vw;
      top: 60vh;
      transform: translateY(-50%);
      z-index: 999;
      font-size: 2vw;
      padding: 1.2vw 2vw;
      box-shadow: 0.4vw 0.4vw 0.8vw rgba(0,0,0,0.3);
    }

    /* ============ Score Container (top-right) ============ */
    #score-container {
      position: fixed;
      top: 1vw;
      right: 1vw;
      background: rgba(255,255,255,0.7);
      border-radius: 1vw;
      padding: 1vw 1.5vw;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      text-align: right;
      z-index: 999;
      min-width: 10vw;
      transform: scale(0.7);
      transform-origin: top right;
    }
    #score-container p {
      margin: 0.5vw 0;
      font-weight: bold;
      color: #2c2c2c;
      font-size: 1.2vw;
    }

    /* ============ Labels, Inputs ============ */
    label {
      display: block;
      margin-bottom: 0.5vw;
      font-weight: bold;
      color: #2c2c2c;
      font-size: 1vw;
    }
    input[type="text"] {
      width: 100%;
      padding: 0.8vw;
      margin-bottom: 0.5vw;
      border-radius: 0.5vw;
      border: 0.1vw solid #ccc;
      font-size: 1vw;
    }
    .radio-group {
      display: flex;
      align-items: center;
      margin: 0.5vw 0;
    }
    .radio-group input[type="radio"] {
      margin-right: 0.5vw;
      transform: scale(1.5);
    }
  </style>
</head>
<body>

  <h1>Gary's Capybara Flashcard App</h1>

  <!-- Score Info in top-right corner -->
  <div id="score-container">
    <p id="score">You answered 0 out of 0 correctly (0%).</p>
    <p id="best-score">Best Score (All Time): 0%</p>
    <p id="time-taken">Time Taken: 0 seconds</p>
  </div>

  <!-- Controls Section -->
  <div class="controls">
    <button id="remove-all-btn">Remove All Questions</button>
    <button id="shuffle-btn">Shuffle Questions</button>
    <button id="reset-btn">Reset Test</button>
  </div>

  <!-- Manage Multiple Sets -->
  <div id="set-management">
    <h2>Manage Question Sets</h2>
    <label for="set-select">Select a Question Set:</label>
    <select id="set-select"></select>
    <button id="load-set-btn">Load Set</button>
    <button id="save-current-as-set-btn">Save Current as New Set</button>
    <button id="delete-set-btn">Delete Set</button>


    <!-- If you have a remove-set feature, add it here -->
    <!-- <button id="remove-set-btn">Remove Set</button> -->
  </div>

  <!-- CSV Import Section -->
  <div id="csv-import">
    <h2>Select a CSV File, Then Add CSV to New Set</h2>
    <p><em>Rows can have 6 columns (4 options) or 7 columns (5 options) + final column for correct answer.</em></p>
    <input type="file" id="csv-file" accept=".csv" />
    <button id="csv-import-btn">Add CSV to New Set</button>
  </div>

  <!-- ADD NEW QUESTION FORM -->
  <div id="question-form">
    <h2>Add New Question</h2>
    <div>
      <label for="new-question">Question:</label>
      <input type="text" id="new-question" placeholder="Enter your question..." />
    </div>
    <label>Options (up to 5):</label>
    <div class="radio-group">
      <input type="radio" name="correctOption" value="0" checked />
      <input type="text" id="option0" placeholder="Option A" />
    </div>
    <div class="radio-group">
      <input type="radio" name="correctOption" value="1" />
      <input type="text" id="option1" placeholder="Option B" />
    </div>
    <div class="radio-group">
      <input type="radio" name="correctOption" value="2" />
      <input type="text" id="option2" placeholder="Option C (optional)" />
    </div>
    <div class="radio-group">
      <input type="radio" name="correctOption" value="3" />
      <input type="text" id="option3" placeholder="Option D (optional)" />
    </div>
    <div class="radio-group">
      <input type="radio" name="correctOption" value="4" />
      <input type="text" id="option4" placeholder="Option E (optional)" />
    </div>
    <button id="add-question-btn">Add Question</button>
  </div>
  
  <!-- The main container for flashcards -->
  <div id="flashcards-container"></div>
  
  <!-- Submit button (scaled via VW, fixed on the left side) -->
  <button id="submit-btn">Submit Test</button>

  <!-- Reset button floating below, hidden initially -->
  <button id="reset-floating-btn" style="display:none;">Reset Test</button>

  <!-- Audio elements for success/fail sounds (optional) -->
  <audio id="success-sound">
    <source src="success.mp3" type="audio/mpeg">
    Your browser does not support the audio element or success.mp3 is missing.
  </audio>
  <audio id="fail-sound">
    <source src="fail.mp3" type="audio/mpeg">
    Your browser does not support the audio element or fail.mp3 is missing.
  </audio>

  <!-- Confetti library (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

  <script>
    /**********************************************************
      MULTIPLE SETS + NO REVIEW MODE + STYLED UI
      (RemoveSet logic optional; remove references if not used)
    **********************************************************/
    let flashcardSets = {};   
    let currentSetName = null;
    let activeFlashcards = [];

    let startTime;
    let bestScore = 0;

    const container       = document.getElementById('flashcards-container');
    const removeAllBtn    = document.getElementById('remove-all-btn');
    const submitBtn       = document.getElementById('submit-btn');
    const shuffleBtn      = document.getElementById('shuffle-btn');
    const resetBtn        = document.getElementById('reset-btn');
    const scoreDiv        = document.getElementById('score');
    const bestScoreDiv    = document.getElementById('best-score');
    const timeTakenDiv    = document.getElementById('time-taken');
    const successSound    = document.getElementById('success-sound');
    const failSound       = document.getElementById('fail-sound');
    const resetFloatingBtn= document.getElementById('reset-floating-btn');

    // Add Question Form
    const addQuestionBtn  = document.getElementById('add-question-btn');
    const newQuestionEl   = document.getElementById('new-question');
    const optionEls       = [
      document.getElementById('option0'),
      document.getElementById('option1'),
      document.getElementById('option2'),
      document.getElementById('option3'),
      document.getElementById('option4')
    ];

    // CSV Import
    const csvFileInput    = document.getElementById('csv-file');
    const csvImportBtn    = document.getElementById('csv-import-btn');

    // Set Management
    const setSelect       = document.getElementById('set-select');
    const loadSetBtn      = document.getElementById('load-set-btn');
    // If you have remove-set, you'd do:
    // const removeSetBtn    = document.getElementById('remove-set-btn');

    /**********************************************************
     * Local Storage for sets
     **********************************************************/
    function loadSetsFromLocalStorage() {
      const saved = localStorage.getItem('flashcardSets');
      if (saved) {
        flashcardSets = JSON.parse(saved);
      } else {
        // Default sample set
        flashcardSets = {
          "Sample": [
            {
              question: "Sample Q: Which factor increases voluntary alcohol consumption in capybaras?",
              options: [
                "Offering them only unsweetened water",
                "Sweetening with sucrose or using food/water deprivation",
                "Exposing them only to high doses that produce sedation",
                "Using capybara-friendly herbal infusions"
              ],
              answer: "Sweetening with sucrose or using food/water deprivation",
              nextDue: 0
            }
          ]
        };
      }
    }
    function saveCurrentAsNewSet() {
  // If there are no active flashcards, nothing to save
  if (!activeFlashcards.length) {
    alert("No questions to save!");
    return;
  }

  // Prompt the user for a new set name
  const newName = prompt("Enter a new set name for these questions:");
  if (!newName) {
    alert("Save canceled, no name provided.");
    return;
  }

  // Check if a set with that name already exists
  if (flashcardSets[newName]) {
    alert(`A set named "${newName}" already exists. Please choose another name.`);
    return;
  }

  // Create a deep copy of the activeFlashcards for the new set
  flashcardSets[newName] = activeFlashcards.map(card => structuredClone(card));

  // Persist to local storage
  saveSetsToLocalStorage();

  // Refresh the dropdown to include the new set
  populateSetDropdown();

  alert(`Saved ${activeFlashcards.length} questions as new set "${newName}".`);
}

    function saveSetsToLocalStorage() {
      localStorage.setItem('flashcardSets', JSON.stringify(flashcardSets));
    }

    /**********************************************************
     * Populate set dropdown
     **********************************************************/
    function populateSetDropdown() {
      setSelect.innerHTML = '';
      for (let setName in flashcardSets) {
        const opt = document.createElement('option');
        opt.value = setName;
        opt.textContent = setName;
        setSelect.appendChild(opt);
      }
    }
function deleteSelectedSet() {
  const chosen = setSelect.value; // the <select> element's value
  if (!chosen) {
    alert("No set selected to delete!");
    return;
  }
  if (!flashcardSets[chosen]) {
    alert("That set does not exist.");
    return;
  }

  if (confirm(`Are you sure you want to delete the entire set "${chosen}"? This cannot be undone.`)) {
    // Remove it from flashcardSets
    delete flashcardSets[chosen];
    saveSetsToLocalStorage();
    populateSetDropdown();

    // If the deleted set was active, clear activeFlashcards
    if (currentSetName === chosen) {
      currentSetName = null;
      activeFlashcards = [];
      renderFlashcards();
    }
    alert(`Set "${chosen}" has been deleted.`);
  }
}

    /**********************************************************
     * Render
     **********************************************************/
    function renderFlashcards() {
      container.innerHTML = '';

      if (!activeFlashcards.length) {
        container.innerHTML = `<p style="color: #2c2c2c; font-weight: bold; background: rgba(255,255,255,0.8); padding: 1vw; border-radius: 0.8vw;">
          No questions available. Add or import some first, or load a set.
        </p>`;
        return;
      }

      activeFlashcards.forEach((card, index) => {
        const cardDiv = document.createElement('div');
        cardDiv.classList.add('flashcard');

        const questionEl = document.createElement('div');
        questionEl.classList.add('question');
        questionEl.textContent = `Q${index + 1}: ${card.question}`;
        cardDiv.appendChild(questionEl);

        const optionsList = document.createElement('ul');
        optionsList.classList.add('options');
        card.options.forEach(option => {
          if (!option) return;
          const li = document.createElement('li');
          li.textContent = option;
          li.addEventListener('click', () => {
            [...optionsList.children].forEach(sib => sib.classList.remove('selected'));
            li.classList.add('selected');
            card.selected = option;
          });
          optionsList.appendChild(li);
        });
        cardDiv.appendChild(optionsList);

        const feedbackEl = document.createElement('div');
        feedbackEl.classList.add('feedback');
        cardDiv.appendChild(feedbackEl);

        // Remove button for this card
        const removeBtn = document.createElement('button');
        removeBtn.textContent = "Remove";
        removeBtn.classList.add('remove-btn');
        removeBtn.addEventListener('click', () => {
          const realIndex = activeFlashcards.indexOf(card);
          if (realIndex >= 0) {
            activeFlashcards.splice(realIndex, 1);
            renderFlashcards();
          }
        });
        cardDiv.appendChild(removeBtn);

        container.appendChild(cardDiv);
      });
    }

    /**********************************************************
     * Submit & Reset
     **********************************************************/
    function runConfetti() {
      const duration = 2000;
      const end = Date.now() + duration;
      (function frame() {
        confetti({
          particleCount: 3,
          startVelocity: 15,
          spread: 360,
          ticks: 60,
          origin: {
            x: Math.random(),
            y: Math.random() - 0.1
          }
        });
        if (Date.now() < end) {
          requestAnimationFrame(frame);
        }
      })();
    }

    function submitTest() {
      if (!activeFlashcards.length) {
        alert("No questions to submit!");
        return;
      }

      let score = 0;
      activeFlashcards.forEach(card => {
        if (card.selected && card.selected === card.answer) {
          score++;
          updateNextDueInSet(card, true);
        } else {
          updateNextDueInSet(card, false);
        }
      });
      saveSetsToLocalStorage();

      const total = activeFlashcards.length;
      const percent = Math.round((score / total) * 100);

      scoreDiv.textContent = `You answered ${score} out of ${total} correctly (${percent}%).`;

      if (percent >= 70) {
        successSound.play().catch(err => console.log("Success sound error:", err));
        runConfetti();
      } else {
        failSound.play().catch(err => console.log("Fail sound error:", err));
      }

      const timeTaken = Math.floor((Date.now() - startTime) / 1000);
      timeTakenDiv.textContent = `Time Taken: ${timeTaken} seconds`;

      if (percent > bestScore) {
        bestScore = percent;
        localStorage.setItem('bestScore', bestScore);
        bestScoreDiv.textContent = `Best Score (All Time): ${bestScore}%`;
      }

      // Reveal the floating Reset button
      resetFloatingBtn.style.display = 'block';
    }

    // Update nextDue in the actual set data so spaced repetition logic remains
    function updateNextDueInSet(card, isCorrect) {
      if (!currentSetName) return;
      const setArray = flashcardSets[currentSetName];
      if (!setArray) return;

      const idx = setArray.findIndex(c => c.question === card.question);
      if (idx >= 0) {
        setArray[idx].selected = card.selected;
        setArray[idx].nextDue = isCorrect
          ? Date.now() + 3 * 24 * 60 * 60 * 1000
          : Date.now() + 1 * 24 * 60 * 60 * 1000;
      }
    }

    function resetTest() {
      activeFlashcards.forEach(card => {
        card.selected = null;
      });
      scoreDiv.textContent = 'You answered 0 out of 0 correctly (0%).';
      timeTakenDiv.textContent = 'Time Taken: 0 seconds';

      renderFlashcards();
      startTime = Date.now();
      resetFloatingBtn.style.display = 'none';
    }

    /**********************************************************
     * Add / Remove All in the Current Active List
     **********************************************************/
    function addQuestion() {
      if (!currentSetName) {
        alert("Please select or create a set before adding questions!");
        return;
      }

      const questionText = newQuestionEl.value.trim();
      if (!questionText) {
        alert("Please enter a question.");
        return;
      }
      const chosenCorrect = document.querySelector('input[name="correctOption"]:checked');
      const correctIndex = chosenCorrect ? parseInt(chosenCorrect.value, 10) : 0;
      const newOptions = [];
      optionEls.forEach(el => {
        const val = el.value.trim();
        if (val) newOptions.push(val);
      });
      if (newOptions.length === 0) {
        alert("Please enter at least one option.");
        return;
      }
      if (correctIndex >= newOptions.length) {
        alert("The correct answer index is beyond the number of options you provided.");
        return;
      }

      const correctAnswer = newOptions[correctIndex];
      const newCard = {
        question: questionText,
        options: newOptions,
        answer: correctAnswer,
        nextDue: 0
      };

      // Add to the set data
      flashcardSets[currentSetName].push(newCard);
      saveSetsToLocalStorage();

      // Also add to the activeFlashcards
      activeFlashcards.push(structuredClone(newCard));

      // Clear form
      newQuestionEl.value = "";
      optionEls.forEach(el => el.value = "");
      document.querySelector('input[name="correctOption"][value="0"]').checked = true;
      renderFlashcards();
    }

    function removeAllQuestions() {
      if (!activeFlashcards.length) {
        alert("No questions to remove.");
        return;
      }
      if (confirm("Remove all currently loaded questions (without deleting from the set)?")) {
        activeFlashcards = [];
        renderFlashcards();
        alert("All active questions have been cleared (set is untouched).");
      }
    }

    /**********************************************************
     * CSV Import -> Store in a new set
     **********************************************************/
    function parseCsv(csvText) {
      const lines = csvText.split(/\r?\n/).map(l => l.trim()).filter(l => l);
      const result = [];
      lines.forEach(line => {
        const parts = line.split(";");
        if (parts.length < 3) return;
        const question = parts[0];
        const correctAnswer = parts[parts.length - 1];
        const rawOptions = parts.slice(1, parts.length - 1);
        const newCard = {
          question,
          options: rawOptions,
          answer: correctAnswer,
          nextDue: 0
        };
        result.push(newCard);
      });
      return result;
    }

    function importFromCSV() {
      const file = csvFileInput.files[0];
      if (!file) {
        alert("Please select a .csv file first!");
        return;
      }

      const setName = prompt("Enter a name for this question set:");
      if (!setName) {
        alert("Import canceled, no set name provided.");
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const newCards = parseCsv(text);
        if (!newCards.length) {
          alert("No questions found in the CSV, or format not recognized.");
          return;
        }
        // Save these cards under the new setName
        flashcardSets[setName] = newCards;
        saveSetsToLocalStorage();
        populateSetDropdown();
        alert(`Added ${newCards.length} questions into set "${setName}"!`);
      };
      reader.readAsText(file);
    }

    /**********************************************************
     * Load a chosen set => create a fresh copy in activeFlashcards
     **********************************************************/
    function loadSelectedSet() {
      const chosen = setSelect.value;
      if (!chosen) {
        alert("No set selected!");
        return;
      }
      currentSetName = chosen;
      const setArray = flashcardSets[chosen] || [];
      // Make a separate copy for activeFlashcards
      activeFlashcards = setArray.map(c => structuredClone(c));
      renderFlashcards();
    }

    /**********************************************************
     * Initialization
     **********************************************************/
    function initApp() {
      loadSetsFromLocalStorage();

      // If we stored a bestScore
      if (localStorage.getItem('bestScore')) {
        bestScore = parseInt(localStorage.getItem('bestScore'), 10);
        bestScoreDiv.textContent = `Best Score (All Time): ${bestScore}%`;
      }

      populateSetDropdown();
      startTime = Date.now();
    }

    /**********************************************************
     * Event Listeners
     **********************************************************/
    removeAllBtn.addEventListener('click', removeAllQuestions);
    shuffleBtn.addEventListener('click', () => {
      if (activeFlashcards.length) {
        for (let i = activeFlashcards.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [activeFlashcards[i], activeFlashcards[j]] = [activeFlashcards[j], activeFlashcards[i]];
        }
      }
      renderFlashcards();
    });
    resetBtn.addEventListener('click', resetTest);
    submitBtn.addEventListener('click', submitTest);
    addQuestionBtn.addEventListener('click', addQuestion);
    csvImportBtn.addEventListener('click', importFromCSV);
    loadSetBtn.addEventListener('click', loadSelectedSet);
    resetFloatingBtn.addEventListener('click', resetTest);
    document.getElementById('save-current-as-set-btn').addEventListener('click', saveCurrentAsNewSet);
    document.getElementById('delete-set-btn').addEventListener('click', deleteSelectedSet);

    initApp();
  </script>
</body>
</html>
